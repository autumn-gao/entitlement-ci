- job-template:
    name: 'jslave-ci-ops-central-{project}-{topology}-1-provision'
    defaults: ci-ops-projex-provision
    node: master
    parameters:
        - choice:
            name: SITE
            choices:
              - qeos
              - os1
            description: |
              Site where to provision resources
    builders:
        - shell: |
            #!/bin/bash

            export JSLAVENAME=ci-ops-central-{project}-{topology}
            # Provision Jenkins Slave as aio
            $WORKSPACE/ci-ops-central/bootstrap/provision_jslave.sh --site=$SITE --project_defaults={project_defaults} \
            --topology=ci-ops-central/project/config/aio_jslave --ssh_keyfile={ssh_keyfile} \
            --jslave_execs={jslave_execs} --jslavename=$JSlAVENAME \
            --jslavecreate --resources_file=ci-ops-central-{project}-{topology}.json

            TR_STATUS=$?

            files=$(ls $WORKSPACE/*.slave 2>/dev/null)
            if [ -e "$files" ]
            then
                cat $WORKSPACE/*.slave >> $WORKSPACE/RESOURCES.txt
            fi

            if [ "$TR_STATUS" != 0 ]; then echo "ERROR: Provisioning\nSTATUS: $TR_STATUS"; exit 1; fi

        - inject:
            properties-file: $WORKSPACE/RESOURCES.txt

    publishers:
      - archive:
          artifacts: '*.txt, *.json'
          allow-empty: 'true'
      - trigger-parameterized-builds:
          - project: 'jslave-{project}-{topology}-2-runtest'
            current-parameters: true
            condition: 'SUCCESS'
            property-file: $WORKSPACE/RESOURCES.txt
            fail-on-missing: true
          - project: 'jslave-ci-ops-central-{project}-{topology}-3-teardown'
            current-parameters: true
            condition: 'UNSTABLE_OR_WORSE'
            property-file: $WORKSPACE/RESOURCES.txt
            fail-on-missing: true

- job-template:
    name: 'jslave-{project}-{topology}-2-runtest'
    defaults: ci-ops-projex-runtest
    node: 'ci-ops-central-{project}-{topology}'
    builders:
        - copyartifact:
            project: 'jslave-ci-ops-central-{project}-{topology}-1-provision'
            filter: '*.txt, *.json'
            target: $WORKSPACE

        - shell: |
            #!/bin/bash

            export TOPOLOGY={topology}
            echo "TOPOLOGY: {topology}"

            echo "Ping Jenkins Slave"
            ping -c 15 $JSLAVEIP

            echo "Jenkins machine info we are running on"
            ifconfig

            cat $WORKSPACE/RESOURCES.txt

    publishers:
      - archive:
          artifacts: '**/**'
          allow-empty: 'true'
      - trigger-parameterized-builds:
          - project: 'jslave-ci-ops-central-{project}-{topology}-3-teardown'
            current-parameters: true

- job-template:
    name: 'jslave-ci-ops-central-{project}-{topology}-3-teardown'
    defaults: ci-ops-projex-provision
    node: master
    builders:
        - shell: |
            #!/bin/bash

            export JSLAVETEARDOWN={jslaveteardown}
            # Teardown Jenkins Slave

            if [ "$JSLAVETEARDOWN" == "True" ]
            then
              $WORKSPACE/ci-ops-central/bootstrap/teardown_jslave.sh --site=$SITE --project_defaults={project_defaults} \
              --topology=ci-ops-central/project/config/aio_jslave --jslavename=$JSLAVENAME \
              --jslaveusername={jslaveusername} --jslavepassword={jslavepassword} --jslaveip=$JSLAVEIP --jslaveteardown

              TR_STATUS=$?
              if [ "$TR_STATUS" != 0 ]; then echo "ERROR: Teardown\nSTATUS: $TR_STATUS"; exit 1; fi
            fi

- job-group:
    name: aio-jslave-provision-runtest-teardown
    jobs:
      - 'jslave-ci-ops-central-{project}-{topology}-1-provision'
      - 'jslave-{project}-{topology}-2-runtest'
      - 'jslave-ci-ops-central-{project}-{topology}-3-teardown'

- project:
    name: jslave-ci-ops-projex-jobs
    project:
     - projex
    project_defaults:
     - ci-ops-projex/config/project_defaults
    topology_path:
     - ci-ops-projex/config
    topology:
     - aio_jslave_RHEL6-4
     - aio_jslave_RHEL6-5
     - aio_jslave_RHEL7-0
    ssh_keyfile:
     - ci-ops-projex/config/keys/ci-ops-central
    jobs:
      - aio-jslave-provision-runtest-teardown
    jslave_execs:
     - 10
    jslaveusername:
     - root
    jslavepassword:
     - 123456
    jslaveteardown:
     - True