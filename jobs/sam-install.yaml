- job-template:
    name: '{project}-{topology}-1-provision'
    defaults: virt-who-provision
    node: master
    builders:
        - shell: |
            #!/bin/bash

            export JSLAVENAME={jslavename}
            # Provision Jenkins Slave
            if [ "$JSLAVENAME" != "master" ]
            then
                $WORKSPACE/ci-ops-central/bootstrap/provision_jslave.sh --site=$SITE --project_defaults={project_defaults} \
                --topology=ci-ops-central/project/config/aio_jslave --ssh_keyfile={ssh_keyfile} \
                --jslavename={jslavename} --jslaveflavor={jslaveflavor} --jslaveimage={jslaveimage} \
                --jslave_execs={jslave_execs} --jslavecreate --resources_file={jslavename}.json

                TR_STATUS=$?
                if [ "$TR_STATUS" != 0 ]; then echo "ERROR: Provisioning\nSTATUS: $TR_STATUS"; exit 1; fi
            fi

            # Provision Test Resources
            $WORKSPACE/ci-ops-central/bootstrap/provision_resources.sh --site=$SITE --project_defaults={project_defaults} \
            --topology={topology_path}/{topology} --ssh_keyfile={ssh_keyfile} --name={project}

            TR_STATUS=$?

            files=$(ls $WORKSPACE/*.slave 2>/dev/null)
            if [ -e "$files" ]
            then
                cat $WORKSPACE/*.slave >> $WORKSPACE/RESOURCES.txt
            fi

            if [ "$TR_STATUS" != 0 ]; then echo "ERROR: Provisioning\nSTATUS: $TR_STATUS"; exit 1; fi


        - inject:
            properties-file: $WORKSPACE/RESOURCES.txt

    publishers:
      - archive:
          artifacts: '*.txt, *.json'
          allow-empty: 'true'
      - trigger-parameterized-builds:
          - project: '{project}-{topology}-2-runtest'
            current-parameters: true
            condition: 'SUCCESS'
            property-file: $WORKSPACE/RESOURCES.txt
            fail-on-missing: true
          - project: '{project}-{topology}-3-teardown'
            current-parameters: true
            condition: 'UNSTABLE_OR_WORSE'
            property-file: $WORKSPACE/RESOURCES.txt
            fail-on-missing: true
      - default-virt-who-publishers


- job-template:
    name: '{project}-{topology}-2-runtest'
    defaults: virt-who-runtest
    node: '{jslavename}'
    builders:
        - copyartifact:
            project: '{project}-{topology}-1-provision'
            filter: '*.txt, *.json'
            target: $WORKSPACE

        - shell: |
            #!/bin/bash

            export TOPOLOGY={topology}
            {testparams}

            echo "TOPOLOGY: {topology}"

            echo "Ping Jenkins Slave"
            ping -c 10 $JSLAVEIP

            echo "Jenkins machine info we are running on"
            ifconfig

            echo "Pinging Test Resources"
            echo $EXISTING_NODES | xargs -i -d , ping -c 15 {{}}
            cat $WORKSPACE/RESOURCES.txt

            export REMOTE_IP=$EXISTING_NODES
            export REMOTE_USER=root
            export REMOTE_PASSWD=xxoo2014
            
#        if [ "$REBOOTCOUNT" -eq 0 ] ; then
            rlRun "setenforce 0" 0 "Set selinux"
            rlRun "sed -i -e 's/SELINUX=.*/SELINUX=permissive/g' /etc/sysconfig/selinux" 0 "Change selinux configure: permissive"
            rlRun "service iptables stop" 0 "Stop iptables service"
            rlRun "subscription-manager register --username=qa@redhat.com --password=uBLybd5JSmkRHebA --auto-attach" 0 "Auto subscribe"
            rlRun "cat > /etc/yum.repos.d/sam.repo <<EOF
[sam]
name=sam
baseurl=http://download.devel.redhat.com/devel/candidate-trees/SAM/latest-SAM-$VERSION-RHEL-6/compose/SAM/x86_64/os/
enabled=1
gpgcheck=0
EOF" 0 "Add SAM latest repo"
            rlRun "yum install -y katello-headpin-all" 0 "Install katello-headpin-all"
#            rhts-reboot
#        fi
#Failed to start katello service, will check later
#        rlRun "katello-configure --deployment=sam --user-pass=admin" 0 "Deploy SAM"
    rlPhaseEnd

    rlPhaseStartTest
        rlRun "wget http://10.66.100.116/projects/sam-virtwho/latest-manifest/sam_install_manifest.zip -P /root/" 0 "Wget manifest from data server"
#        rlRun "headpin -u admin -p admin provider import_manifest --org=ACME_Corporation --name='Red Hat' --file=/root/sam_install_manifest.zip" 0 "Import entitlement team related manifest"
#        rlLogInfo "$(rpm -q katello katello-cli candlepin katello-configure katello-cli-common katello-common subscription-manager python-rhsm)"
    rlPhaseEnd

    publishers:
      - archive:
          artifacts: '**/**'
          allow-empty: 'true'
      - default-virt-who-runtest-publishers
      - trigger-parameterized-builds:
          - project: '{project}-{topology}-3-teardown'
            current-parameters: true
      - default-virt-who-publishers

- job-template:
    name: '{project}-{topology}-3-teardown'
    defaults: virt-who-provision
    node: master
    builders:
        - shell: |
            #here I do not want to teardown anything
            #!/bin/bash

- job-group:
    name: sam-install-provision-runtest-teardown
    jobs:
      - '{project}-{topology}-1-provision'
      - '{project}-{topology}-2-runtest'
      - '{project}-{topology}-3-teardown'

- project:
    name: sam-install-jobs
    project:
     - sam-install
    project_defaults:
     - entitlement-ci/config/project_defaults
    topology_path:
     - entitlement-ci/config
    topology:
     - bkr_sam_install
    ssh_keyfile:
     - entitlement-ci/config/keys/ent-key
    tests_path:
     - entitlement-ci/tests
    testparams:
     - echo "I am a test parameter"
    jobs:
      - sam-install-provision-runtest-teardown
    jslavename:
     - jslave-sam-install-slave
    jslave_execs:
     - 10
    jslaveimage:
     - rhel-6.5_jeos
    jslaveflavor:
     - m1.large
    jslaveusername:
     - root
    jslavepassword:
     - redhat
    jslaveteardown:
     - True